<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DropLAN — Local File Sharing</title>
    <link rel="icon" type="image/png" href="/static/logo.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            scrollbar-width: thin;
            scrollbar-color: #334155 transparent;
        }
        *::-webkit-scrollbar { width: 6px; }
        *::-webkit-scrollbar-track { background: transparent; }
        *::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        
        .card {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(71, 85, 105, 0.3);
        }
        
        .card-hover:hover {
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.1);
        }
        
        .drop-zone {
            background: repeating-linear-gradient(
                -45deg,
                transparent,
                transparent 8px,
                rgba(71, 85, 105, 0.1) 8px,
                rgba(71, 85, 105, 0.1) 16px
            );
        }
        
        .drop-zone.drag-over {
            background: rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }
        
        .btn {
            transition: all 0.15s ease;
        }
        .btn:active {
            transform: scale(0.97);
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse-dot {
            animation: pulse-dot 2s infinite;
        }
        
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .spinner {
            border: 2px solid rgba(255,255,255,0.1);
            border-top-color: #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen bg-dark-950 text-dark-100 font-sans">
    <!-- Header -->
    <header class="border-b border-dark-800 bg-dark-900/80 backdrop-blur-sm sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-400 flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-semibold text-white">DropLAN</h1>
                        <p class="text-xs text-dark-400">Local file sharing</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div id="connection-indicator" class="flex items-center gap-2 text-sm">
                        <span class="w-2 h-2 rounded-full bg-dark-500 pulse-dot"></span>
                        <span class="text-dark-400">Connecting...</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8">
        <!-- Network Bar -->
        <div class="card rounded-xl p-4 mb-8 fade-in">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-dark-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071c3.904-3.905 10.236-3.905 14.141 0"/>
                        </svg>
                        <span class="text-dark-400 text-sm">Network:</span>
                        <span id="wifi-name" class="text-white text-sm font-medium">—</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-dark-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9"/>
                        </svg>
                        <span class="text-dark-400 text-sm">IP:</span>
                        <span id="device-ip" class="text-white text-sm font-medium font-mono">—</span>
                    </div>
                    <div class="hidden sm:flex items-center gap-2">
                        <svg class="w-4 h-4 text-dark-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2"/>
                        </svg>
                        <span class="text-dark-400 text-sm">Host:</span>
                        <span id="hostname" class="text-white text-sm font-medium">—</span>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-dark-400 text-xs">Files expire in 30 min</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- File Bucket -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Upload Zone -->
                <div class="card card-hover rounded-xl p-6 fade-in" style="animation-delay: 0.05s">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                            <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            File Bucket
                        </h2>
                        <div class="flex gap-2">
                            <button id="download-all-btn" class="btn text-dark-300 hover:text-white hover:bg-dark-700 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-1.5">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                                Download All
                            </button>
                            <button id="clear-bucket-btn" class="btn text-dark-300 hover:text-red-400 hover:bg-red-500/10 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-1.5">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                                Clear
                            </button>
                        </div>
                    </div>
                    
                    <!-- Drop Zone -->
                    <div id="upload-area" class="drop-zone border-2 border-dashed border-dark-600 rounded-xl p-8 text-center cursor-pointer transition-all hover:border-dark-500">
                        <input type="file" id="file-input" multiple class="hidden">
                        <div class="w-12 h-12 rounded-full bg-dark-800 flex items-center justify-center mx-auto mb-3">
                            <svg class="w-6 h-6 text-dark-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                        </div>
                        <p class="text-dark-300 font-medium mb-1">Drop files here or click to browse</p>
                        <p class="text-dark-500 text-sm">Any file type • Max 100MB per file</p>
                    </div>
                    
                    <!-- Upload Button -->
                    <button id="upload-btn" class="btn w-full mt-4 bg-blue-600 hover:bg-blue-500 text-white py-2.5 rounded-lg font-medium transition-colors flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                        </svg>
                        Upload Files
                    </button>
                </div>

                <!-- File List -->
                <div class="card card-hover rounded-xl p-6 fade-in" style="animation-delay: 0.1s">
                    <h3 class="text-sm font-medium text-dark-400 uppercase tracking-wider mb-4">Shared Files</h3>
                    <div id="file-list" class="space-y-2 max-h-80 overflow-y-auto">
                        <div class="text-center py-12">
                            <div class="w-16 h-16 rounded-full bg-dark-800 flex items-center justify-center mx-auto mb-3">
                                <svg class="w-8 h-8 text-dark-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                            <p class="text-dark-500">No files shared yet</p>
                            <p class="text-dark-600 text-sm mt-1">Drop files above to share</p>
                        </div>
                    </div>
                </div>

                <!-- Notes Section -->
                <div class="card card-hover rounded-xl p-6 fade-in" style="animation-delay: 0.15s">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                            <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                            </svg>
                            Quick Notes
                        </h2>
                        <button id="clear-notes-btn" class="btn text-dark-300 hover:text-red-400 hover:bg-red-500/10 px-3 py-1.5 rounded-lg text-sm font-medium transition-colors">
                            Clear All
                        </button>
                    </div>
                    
                    <!-- Note Input -->
                    <div class="flex gap-2 mb-4">
                        <textarea id="note-input" placeholder="Type a quick note to share across devices..." rows="2" class="flex-1 bg-dark-800 border border-dark-700 rounded-lg px-4 py-3 text-white placeholder-dark-500 focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 resize-none text-sm"></textarea>
                        <button id="save-note-btn" class="btn bg-amber-600 hover:bg-amber-500 text-white px-4 rounded-lg font-medium transition-colors self-end">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Notes List -->
                    <div id="notes-list" class="space-y-2 max-h-64 overflow-y-auto">
                        <div class="text-center py-8">
                            <p class="text-dark-500 text-sm">No notes yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- QR Code -->
                <div class="card card-hover rounded-xl p-6 fade-in" style="animation-delay: 0.2s">
                    <h2 class="text-lg font-semibold text-white mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                        </svg>
                        Connect Device
                    </h2>
                    
                    <div id="qr-container" class="bg-white rounded-xl p-4 mb-4">
                        <div class="w-full aspect-square flex items-center justify-center">
                            <div class="spinner"></div>
                        </div>
                    </div>
                    
                    <p class="text-dark-400 text-sm text-center mb-4">Scan with your phone to connect</p>
                    
                    <!-- Manual IP -->
                    <div class="flex gap-2">
                        <input id="manual-ip-input" type="text" placeholder="Manual IP" class="flex-1 bg-dark-800 border border-dark-700 rounded-lg px-3 py-2 text-white placeholder-dark-500 focus:outline-none focus:border-blue-500 text-sm font-mono">
                        <button id="generate-qr-btn" class="btn bg-dark-700 hover:bg-dark-600 text-white px-3 py-2 rounded-lg transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- LAN Devices -->
                <div class="card card-hover rounded-xl p-6 fade-in" style="animation-delay: 0.25s">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                            <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                            </svg>
                            Devices
                        </h2>
                        <button id="refresh-devices-btn" class="btn text-dark-400 hover:text-white p-1.5 rounded-lg hover:bg-dark-700 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div id="lan-devices-list" class="space-y-2 max-h-64 overflow-y-auto">
                        <div class="text-center py-6">
                            <div class="spinner mx-auto mb-2"></div>
                            <p class="text-dark-500 text-sm">Scanning...</p>
                        </div>
                    </div>
                </div>

                <!-- Info Card -->
                <div class="card rounded-xl p-4 fade-in" style="animation-delay: 0.3s">
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center flex-shrink-0">
                            <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <div>
                            <p class="text-dark-300 text-sm">All devices must be on the <span class="text-white font-medium">same WiFi network</span> to share files.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 space-y-2"></div>

    <script>
        let files = {};
        let notes = {};
        let connected = false;

        const elements = {
            uploadArea: document.getElementById('upload-area'),
            fileInput: document.getElementById('file-input'),
            uploadBtn: document.getElementById('upload-btn'),
            downloadAllBtn: document.getElementById('download-all-btn'),
            clearBucketBtn: document.getElementById('clear-bucket-btn'),
            fileList: document.getElementById('file-list'),
            noteInput: document.getElementById('note-input'),
            saveNoteBtn: document.getElementById('save-note-btn'),
            clearNotesBtn: document.getElementById('clear-notes-btn'),
            notesList: document.getElementById('notes-list'),
            wifiName: document.getElementById('wifi-name'),
            deviceIp: document.getElementById('device-ip'),
            hostname: document.getElementById('hostname'),
            qrContainer: document.getElementById('qr-container'),
            manualIpInput: document.getElementById('manual-ip-input'),
            generateQrBtn: document.getElementById('generate-qr-btn'),
            lanDevicesList: document.getElementById('lan-devices-list'),
            refreshDevicesBtn: document.getElementById('refresh-devices-btn'),
            connectionIndicator: document.getElementById('connection-indicator'),
            toastContainer: document.getElementById('toast-container')
        };

        // Toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-emerald-600',
                error: 'bg-red-600',
                info: 'bg-blue-600',
                warning: 'bg-amber-600'
            };
            const icons = {
                success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>',
                error: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>',
                info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>',
                warning: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>'
            };
            
            toast.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg fade-in flex items-center gap-3 text-sm`;
            toast.innerHTML = `
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">${icons[type]}</svg>
                <span>${message}</span>
            `;
            
            elements.toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(20px)';
                toast.style.transition = 'all 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function formatFileSize(bytes) {
            const sizes = ['B', 'KB', 'MB', 'GB'];
            if (bytes === 0) return '0 B';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
        }

        function formatTimeAgo(timestamp) {
            const diff = Math.floor((Date.now() - timestamp) / 1000);
            if (diff < 60) return 'just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            return `${Math.floor(diff / 3600)}h ago`;
        }

        function formatCountdown(expiryTimestamp) {
            let secondsLeft = Math.max(0, Math.floor((expiryTimestamp - Date.now()) / 1000));
            const m = Math.floor(secondsLeft / 60);
            const s = secondsLeft % 60;
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const types = {
                image: ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp'],
                video: ['mp4', 'mov', 'avi', 'mkv', 'webm'],
                audio: ['mp3', 'wav', 'flac', 'aac', 'm4a'],
                doc: ['pdf', 'doc', 'docx', 'txt', 'rtf'],
                code: ['js', 'py', 'html', 'css', 'json', 'ts', 'jsx', 'tsx'],
                archive: ['zip', 'rar', '7z', 'tar', 'gz']
            };
            
            for (const [type, exts] of Object.entries(types)) {
                if (exts.includes(ext)) {
                    const icons = {
                        image: 'M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z',
                        video: 'M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z',
                        audio: 'M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3',
                        doc: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
                        code: 'M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4',
                        archive: 'M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4'
                    };
                    return icons[type];
                }
            }
            return 'M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z';
        }

        let countdownInterval = null;

        // API
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, options);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response;
            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Files
        async function loadFiles() {
            try {
                const response = await apiCall('/api/bucket/files');
                files = await response.json();
                renderFileList();
            } catch {}
        }

        async function uploadFiles() {
            const fileList = elements.fileInput.files;
            if (fileList.length === 0) {
                showToast('Select files to upload', 'warning');
                return;
            }
            
            elements.uploadBtn.disabled = true;
            elements.uploadBtn.innerHTML = '<div class="spinner mx-auto"></div>';
            
            try {
                for (const file of fileList) {
                    const formData = new FormData();
                    formData.append('file', file);
                    await apiCall('/api/upload/file', { method: 'POST', body: formData });
                }
                elements.fileInput.value = '';
                await loadFiles();
                showToast(`${fileList.length} file${fileList.length > 1 ? 's' : ''} uploaded`, 'success');
            } finally {
                elements.uploadBtn.disabled = false;
                elements.uploadBtn.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                    </svg>
                    Upload Files
                `;
            }
        }

        async function downloadFile(id) {
            window.open(`/api/download/${id}`, '_blank');
        }

        async function deleteFile(id) {
            await apiCall(`/api/delete/file/${id}`, { method: 'DELETE' });
            await loadFiles();
            showToast('File deleted', 'success');
        }

        async function clearBucket() {
            if (!confirm('Clear all files?')) return;
            await apiCall('/api/clear/bucket', { method: 'DELETE' });
            await loadFiles();
            showToast('Bucket cleared', 'success');
        }

        async function downloadAllFiles() {
            const ids = Object.keys(files);
            if (ids.length === 0) {
                showToast('No files to download', 'warning');
                return;
            }
            for (const id of ids) {
                await downloadFile(id);
                await new Promise(r => setTimeout(r, 200));
            }
        }

        function renderFileList() {
            const entries = Object.entries(files);
            if (entries.length === 0) {
                elements.fileList.innerHTML = `
                    <div class="text-center py-12">
                        <div class="w-16 h-16 rounded-full bg-dark-800 flex items-center justify-center mx-auto mb-3">
                            <svg class="w-8 h-8 text-dark-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1M5 19h14a2 2 0 002-2v-5a2 2 0 00-2-2H9a2 2 0 00-2 2v5a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                        <p class="text-dark-500">No files shared yet</p>
                        <p class="text-dark-600 text-sm mt-1">Drop files above to share</p>
                    </div>
                `;
                return;
            }
            
            elements.fileList.innerHTML = entries.map(([id, file]) => {
                const expiry = file.timestamp + 30 * 60 * 1000;
                return `
                    <div class="group flex items-center justify-between p-3 rounded-lg bg-dark-800/50 hover:bg-dark-800 transition-colors fade-in" data-file-id="${id}">
                        <div class="flex items-center gap-3 min-w-0">
                            <div class="w-10 h-10 rounded-lg bg-dark-700 flex items-center justify-center flex-shrink-0">
                                <svg class="w-5 h-5 text-dark-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${getFileIcon(file.name)}"/>
                                </svg>
                            </div>
                            <div class="min-w-0">
                                <p class="text-white text-sm font-medium truncate">${file.name}</p>
                                <p class="text-dark-500 text-xs">${formatFileSize(file.size || 0)} • <span class="file-countdown text-dark-400" data-expiry="${expiry}"></span></p>
                            </div>
                        </div>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="downloadFile('${id}')" class="btn p-2 text-dark-400 hover:text-emerald-400 hover:bg-emerald-500/10 rounded-lg transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                                </svg>
                            </button>
                            <button onclick="deleteFile('${id}')" class="btn p-2 text-dark-400 hover:text-red-400 hover:bg-red-500/10 rounded-lg transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            startCountdownUpdater();
        }

        function startCountdownUpdater() {
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                document.querySelectorAll('.file-countdown').forEach(el => {
                    const expiry = parseInt(el.getAttribute('data-expiry'));
                    if (expiry - Date.now() <= 0) {
                        loadFiles();
                    } else {
                        el.textContent = formatCountdown(expiry);
                    }
                });
            }, 1000);
        }

        // Notes
        async function loadNotes() {
            try {
                const response = await apiCall('/api/bucket/notes');
                notes = await response.json();
                renderNotesList();
            } catch {}
        }

        async function saveNote() {
            const content = elements.noteInput.value.trim();
            if (!content) {
                showToast('Enter a note first', 'warning');
                return;
            }
            await apiCall('/api/upload/note', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });
            elements.noteInput.value = '';
            await loadNotes();
            showToast('Note saved', 'success');
        }

        async function deleteNote(id) {
            await apiCall(`/api/delete/note/${id}`, { method: 'DELETE' });
            await loadNotes();
            showToast('Note deleted', 'success');
        }

        async function copyNote(content) {
            await navigator.clipboard.writeText(content);
            showToast('Copied to clipboard', 'success');
        }

        async function clearAllNotes() {
            if (!confirm('Clear all notes?')) return;
            await apiCall('/api/clear/notes', { method: 'DELETE' });
            await loadNotes();
            showToast('Notes cleared', 'success');
        }

        function renderNotesList() {
            const entries = Object.entries(notes);
            if (entries.length === 0) {
                elements.notesList.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-dark-500 text-sm">No notes yet</p>
                    </div>
                `;
                return;
            }

            elements.notesList.innerHTML = entries.map(([id, note]) => `
                <div class="group p-3 rounded-lg bg-dark-800/50 hover:bg-dark-800 transition-colors fade-in">
                    <div class="flex justify-between items-start gap-2">
                        <div class="flex-1 min-w-0">
                            <p class="text-dark-200 text-sm whitespace-pre-wrap break-words">${note.content}</p>
                            <p class="text-dark-600 text-xs mt-2">${formatTimeAgo(note.timestamp)}</p>
                        </div>
                        <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity flex-shrink-0">
                            <button onclick="copyNote(\`${note.content.replace(/`/g, '\\`').replace(/\\/g, '\\\\')}\`)" class="btn p-1.5 text-dark-400 hover:text-blue-400 hover:bg-blue-500/10 rounded transition-colors">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                                </svg>
                            </button>
                            <button onclick="deleteNote('${id}')" class="btn p-1.5 text-dark-400 hover:text-red-400 hover:bg-red-500/10 rounded transition-colors">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Network
        async function loadNetworkInfo() {
            try {
                const response = await apiCall('/api/network-info');
                const data = await response.json();
                elements.wifiName.textContent = data.wifi_name || 'Unknown';
                elements.deviceIp.textContent = data.ip || 'Unknown';
                elements.hostname.textContent = data.hostname || 'Unknown';
                if (data.ip) generateQRCode(data.ip);
            } catch {
                elements.wifiName.textContent = 'Error';
                elements.deviceIp.textContent = 'Error';
                elements.hostname.textContent = 'Error';
            }
        }

        async function generateQRCode(ip) {
            try {
                elements.qrContainer.innerHTML = `<div class="w-full aspect-square flex items-center justify-center"><div class="spinner"></div></div>`;
                const response = await apiCall(`/api/qr/?ip=${encodeURIComponent(ip)}`);
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                elements.qrContainer.innerHTML = `<img src="${url}" alt="QR Code" class="w-full aspect-square rounded-lg">`;
            } catch {
                elements.qrContainer.innerHTML = `<div class="w-full aspect-square flex items-center justify-center text-red-400 text-sm">Failed to load QR</div>`;
            }
        }

        // Devices
        async function refreshDevices() {
            elements.lanDevicesList.innerHTML = `
                <div class="text-center py-6">
                    <div class="spinner mx-auto mb-2"></div>
                    <p class="text-dark-500 text-sm">Scanning...</p>
                </div>
            `;
            try {
                const response = await apiCall('/api/lan-devices');
                const data = await response.json();
                if (data.devices && data.devices.length > 0) {
                    elements.lanDevicesList.innerHTML = data.devices.map(device => `
                        <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-dark-800 transition-colors fade-in">
                            <div class="w-8 h-8 rounded-lg bg-dark-700 flex items-center justify-center">
                                <svg class="w-4 h-4 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                                </svg>
                            </div>
                            <div class="min-w-0">
                                <p class="text-white text-sm font-medium truncate">${device.hostname || 'Unknown'}</p>
                                <p class="text-dark-500 text-xs font-mono">${device.ip}</p>
                            </div>
                        </div>
                    `).join('');
                } else {
                    elements.lanDevicesList.innerHTML = `
                        <div class="text-center py-6">
                            <p class="text-dark-500 text-sm">No devices found</p>
                        </div>
                    `;
                }
            } catch {
                elements.lanDevicesList.innerHTML = `<div class="text-center py-6 text-red-400 text-sm">Scan failed</div>`;
            }
        }

        function updateConnectionStatus(isConnected) {
            connected = isConnected;
            if (connected) {
                elements.connectionIndicator.innerHTML = `
                    <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                    <span class="text-dark-300">Connected</span>
                `;
            } else {
                elements.connectionIndicator.innerHTML = `
                    <span class="w-2 h-2 rounded-full bg-dark-500 pulse-dot"></span>
                    <span class="text-dark-400">Connecting...</span>
                `;
            }
        }

        // Event Listeners
        elements.uploadArea.addEventListener('click', () => elements.fileInput.click());
        elements.uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            elements.uploadArea.classList.add('drag-over');
        });
        elements.uploadArea.addEventListener('dragleave', () => {
            elements.uploadArea.classList.remove('drag-over');
        });
        elements.uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            elements.uploadArea.classList.remove('drag-over');
            elements.fileInput.files = e.dataTransfer.files;
            uploadFiles();
        });

        elements.uploadBtn.addEventListener('click', uploadFiles);
        elements.downloadAllBtn.addEventListener('click', downloadAllFiles);
        elements.clearBucketBtn.addEventListener('click', clearBucket);

        elements.saveNoteBtn.addEventListener('click', saveNote);
        elements.noteInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
                saveNote();
            }
        });
        elements.clearNotesBtn.addEventListener('click', clearAllNotes);

        elements.generateQrBtn.addEventListener('click', () => {
            const ip = elements.manualIpInput.value.trim();
            if (ip) generateQRCode(ip);
            else showToast('Enter an IP address', 'warning');
        });

        elements.refreshDevicesBtn.addEventListener('click', refreshDevices);

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadNetworkInfo();
            await loadFiles();
            await loadNotes();
            await refreshDevices();
        });

        // Socket.io
        const socket = io();
        socket.on('connect', () => {
            updateConnectionStatus(true);
            showToast('Connected to server', 'success');
        });
        socket.on('disconnect', () => {
            updateConnectionStatus(false);
        });
        socket.on('file_uploaded', () => loadFiles());
        socket.on('file_deleted', () => loadFiles());
        socket.on('bucket_cleared', () => { loadFiles(); loadNotes(); });
        socket.on('file_expired', () => loadFiles());
        socket.on('note_uploaded', () => loadNotes());
        socket.on('note_deleted', () => loadNotes());
        socket.on('notes_cleared', () => loadNotes());
        socket.on('note_expired', () => loadNotes());
    </script>
</body>
</html>
